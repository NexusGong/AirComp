# 按需求气量与压力自动匹配供应商设备 — 算法设计

## 1. 目标

在计算/选型过程中，**根据客户当前开启设备的总需求气量、需求压力**，自动给出：**供应商应提供几台、什么型号的设备**，使总供气能力满足需求且压力达标。

---

## 2. 输入与输出

### 2.1 输入

| 名称 | 含义 | 单位 | 来源 |
|------|------|------|------|
| **需求气量** `Q_demand` | 客户侧总用气量（供气需满足的下限） | m³/min | 见下文「需求汇总」 |
| **需求压力** `P_demand` | 客户侧要求的最低供气压力 | MPa | 见下文「需求汇总」 |
| **供应商设备库** | 可选机型列表（来自 `MachineSupplier`） | - | 当前用户可见的供应商机型 |

可选策略参数（可做成配置或前端选项）：

- **余量系数** `margin_ratio`：建议 ≥ 1.0，如 1.05～1.15，表示「总供气能力 ≥ Q_demand × margin_ratio」。
- **优化目标**：最少台数 / 最低总功率 / 最低总能耗（或综合）。
- **最大推荐台数**：如 1～6 台，避免推荐过多小机。

### 2.2 输出

- **推荐方案**：一个或多个组合，每个组合包含：
  - 若干台供应商设备（型号、每台台数、单台气量、单台额定压力、比功率等）；
  - 该组合总气量、是否满足压力、是否满足气量（含余量）；
  - 可选：预估总功率、年耗电、与当前客户机对比的节电等。

---

## 3. 需求侧：如何得到「需求气量」与「需求压力」

客户有多台**已开启/参与计算的客户机**时，从这些设备汇总得到「客户总需求」。

### 3.1 需求气量 Q_demand

两种口径（可二选一或都支持）：

- **口径 A — 按实际加载产气汇总（推荐）**  
  对每台参与计算的客户机：
  - 单台等效产气 = `air_i × (load_time_i / run_time_i)`（工频按加载率折算）；
  - 若为变频，可用品牌默认加载率 `por(brand)` 代替 `load_time/run_time`。
  - **Q_demand = Σ 单台等效产气**  
  含义：当前客户在统计周期内「实际用气」对应的平均流量需求。

- **口径 B — 按额定气量汇总**  
  **Q_demand = Σ air_i**  
  含义：客户所有开启设备的额定产气之和，偏「按满负荷设计」的保守需求。

建议默认用 **口径 A**；若用户希望按「设计容量」选型，可选用口径 B 或在前端提供选项。

### 3.2 需求压力 P_demand

- 取当前参与计算的客户机中 **实际运行压力的最大值**：  
  **P_demand = max(actual_pre_i)**  
- 若只有一台或压力一致，即为该压力。  
- 含义：供应商设备额定压力必须 ≥ P_demand，才能满足现场最高压力需求。

---

## 4. 供应侧：候选设备与约束

### 4.1 推荐逻辑顺序（实现约定）

1. **首先**：只保留 **供应商额定压力 ≥ 客户实际压力**（P_demand = max(actual_pre)）的机型，不满足的机型不参与组合。
2. **其次**：在候选机型中匹配客户的**用气量（流量）和台数**，生成**多种可能的组合**（如能效优先、大机优先等），供用户选择。

### 4.2 数据来源

- 从 `MachineSupplier` 表（或当前用户可见的供应商机型列表）读取每条机型：
  - `air`：额定排气量 (m³/min)
  - `origin_pre`：额定压力 (MPa)
  - `model`, `brand`, `ori_power`, `energy_con`, `is_FC` 等用于展示与排序

### 4.3 硬约束（必须满足）

1. **压力**：供应商机型的 **额定压力 ≥ P_demand**。  
   - 不满足的机型直接排除，不参与组合。
2. **气量**：某组合下，**所有选中机型的额定气量之和 ≥ Q_demand × margin_ratio**。  
   - 同一机型可重复选多台（台数 ≥ 1 的整数）。

---

## 5. 匹配算法：组合生成与排序

### 5.1 思路概述

- 在满足「压力 + 气量」的前提下，枚举或搜索**设备组合**（每台设备型号 + 台数）。
- 对每个可行组合打分，按「优化目标」排序，取前若干条作为推荐方案。

### 5.2 组合生成（两种实现思路）

**方式一：贪心 + 台数上限（实现简单、推荐先做）**

1. 过滤：只保留 `origin_pre >= P_demand` 的机型，按单台气量从大到小排序（或按能效排序，见下）。
2. 设目标气量 `Q_target = Q_demand × margin_ratio`，当前已选组合 `selected = []`，当前总气量 `Q_sum = 0`。
3. 贪心选机：
   - 若 `Q_sum >= Q_target`：结束，得到一种组合。
   - 否则在未选机型中选一台（可重复选同一型号），优先规则示例：
     - 优先「单台气量大」的机型（大机优先），或
     - 优先「energy_con 小」的机型（能效优先），
   - 将该机型加入 `selected`（或该型号台数 +1），更新 `Q_sum`。
4. 限制总台数（如 ≤ 6 台），超过则停止并返回当前组合（或标记「未完全满足」）。
5. 可再生成 1～2 个备选：例如「能效优先」一个方案、「大机优先」一个方案。

**方式二：有限枚举（更全，适合机型数不多时）**

1. 同样先过滤压力，得到候选机型列表。
2. 设定单型号最大台数（如 1～4 台）、总台数上限（如 1～6 台）。
3. 枚举每个机型的台数，得到所有「总气量 ≥ Q_target、总台数 ≤ 上限」的组合。
4. 对每个组合按优化目标打分，排序后取前 N 个（如前 3 个）作为推荐。

### 5.3 优化目标与排序（可选其一或综合打分）

- **最少台数**：总台数越少越好（运维简单）。
- **最低总功率**：Σ(单台 ori_power × 台数) 越小越好。
- **最低总能耗**：在相同运行时间下，按「比功率 × 该台承担气量」估算耗电，总耗电越低越好；或直接用 `energy_con * air * 台数` 的某种加权和作为代理指标。
- **综合**：例如 `score = a×台数 + b×总功率 + c×预估年电费`，权重 a、b、c 可配置。

输出时至少给出：**推荐组合列表**（每组合包含型号、台数、单台气量、总气量、是否满足压力/气量）。

---

## 6. 与现有计算流程的衔接

- **入口**：在「计算」或「选型」流程中，当用户已选择要参与对比的**客户机**（即当前开启的设备）后：
  1. 用上述规则汇总得到 `Q_demand`、`P_demand`。
  2. 从供应商库取候选机型，执行匹配算法，得到推荐方案。
- **下游**：
  - 推荐方案可与现有「客户机 vs 供应商机」的对比逻辑结合：用推荐出来的供应商机型列表，生成或预填「对比关系」，再走现有能效对比与年节电计算（年运行时间已按 8000 小时）。
  - Excel 或界面上可增加一栏/一表：「根据您当前需求，推荐配置：X 台 型号A + Y 台 型号B」。

---

## 7. 小结

| 步骤 | 内容 |
|------|------|
| 1 | 从客户已选设备汇总 **Q_demand**（建议用加载率折算的实际用气）和 **P_demand**（max(actual_pre)） |
| 2 | 供应商库中过滤 **origin_pre ≥ P_demand**，得到候选机型 |
| 3 | 用贪心或枚举生成「总气量 ≥ Q_demand×余量系数」的设备组合，同一型号可多台 |
| 4 | 按台数/总功率/能效等目标排序，输出前几条推荐方案 |
| 5 | 与现有能效计算衔接：用推荐方案参与对比与节电量计算 |

若你确认采用「口径 A + 压力取 max(actual_pre) + 贪心大机优先/能效优先 + 余量系数可配置」，我可以按该设计在 `cal_func` 或新模块里实现具体函数与接口。
